# KIS Demoシステム - クラス・データ構造定義

## 📋 概要

KIS Demoシステムにおける主要なクラス、データモデル、データベーステーブル設計を詳細に説明します。システムはTypeScriptによる型安全な設計とSQLiteデータベースを使用した階層化されたデータ構造を採用しています。

## 🏗️ アーキテクチャ概要

```
┌─────────────────────────────────┐
│ TypeScript Interface Layer      │ Frontend/Backend Types
├─────────────────────────────────┤
│ Model Class Layer               │ BaseModel + Specific Models
├─────────────────────────────────┤
│ Database Schema Layer           │ SQLite Tables
└─────────────────────────────────┘
```

## 🗄️ データベーステーブル定義

### 1. users テーブル（ユーザー管理）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ユーザーID |
| username | VARCHAR(50) | UNIQUE NOT NULL | ユーザー名 |
| email | VARCHAR(100) | UNIQUE NOT NULL | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ（bcrypt） |
| role | VARCHAR(20) | DEFAULT 'user' | ユーザーロール（admin/user） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**: なし（主キーのみ）

### 2. customers テーブル（顧客管理）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 顧客ID |
| customer_code | VARCHAR(20) | UNIQUE NOT NULL | 顧客コード |
| name | VARCHAR(100) | NOT NULL | 顧客名 |
| email | VARCHAR(100) | NULL | メールアドレス |
| phone | VARCHAR(20) | NULL | 電話番号 |
| address | TEXT | NULL | 住所 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新日時 |
| created_by | INTEGER | FOREIGN KEY → users(id) | 作成者ID |

**インデックス**: `idx_customers_code` (customer_code)

### 3. products テーブル（商品管理）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 商品ID |
| product_code | VARCHAR(20) | UNIQUE NOT NULL | 商品コード |
| name | VARCHAR(100) | NOT NULL | 商品名 |
| description | TEXT | NULL | 商品説明 |
| price | DECIMAL(10,2) | NOT NULL | 単価 |
| stock_quantity | INTEGER | DEFAULT 0 | 在庫数量 |
| category | VARCHAR(50) | NULL | カテゴリ |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新日時 |
| created_by | INTEGER | FOREIGN KEY → users(id) | 作成者ID |

**インデックス**: `idx_products_code` (product_code)

### 4. orders テーブル（注文管理）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 注文ID |
| order_number | VARCHAR(20) | UNIQUE NOT NULL | 注文番号 |
| customer_id | INTEGER | NOT NULL, FOREIGN KEY → customers(id) | 顧客ID |
| total_amount | DECIMAL(10,2) | NOT NULL | 注文総額 |
| status | VARCHAR(20) | DEFAULT 'pending' | 注文ステータス |
| order_date | DATETIME | DEFAULT CURRENT_TIMESTAMP | 注文日時 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新日時 |
| created_by | INTEGER | FOREIGN KEY → users(id) | 作成者ID |

**インデックス**: 
- `idx_orders_number` (order_number)
- `idx_orders_customer` (customer_id)

### 5. order_items テーブル（注文明細）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 注文明細ID |
| order_id | INTEGER | NOT NULL, FOREIGN KEY → orders(id) ON DELETE CASCADE | 注文ID |
| product_id | INTEGER | NOT NULL, FOREIGN KEY → products(id) | 商品ID |
| quantity | INTEGER | NOT NULL | 数量 |
| unit_price | DECIMAL(10,2) | NOT NULL | 単価 |
| subtotal | DECIMAL(10,2) | NOT NULL | 小計 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**インデックス**: `idx_order_items_order` (order_id)

### 6. permission_matrix テーブル（権限管理）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 権限ID |
| user_id | INTEGER | NOT NULL, FOREIGN KEY → users(id) | ユーザーID |
| entity_type | VARCHAR(20) | NOT NULL | エンティティタイプ |
| operation_type | VARCHAR(10) | NOT NULL | 操作タイプ |
| screen_name | VARCHAR(50) | NOT NULL | 画面名 |
| is_allowed | BOOLEAN | DEFAULT FALSE | 許可フラグ |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**: 
- `idx_permission_matrix_user` (user_id)
- `idx_permission_matrix_entity` (entity_type, operation_type)

**UNIQUE制約**: (user_id, entity_type, operation_type, screen_name)

## 🔗 ER図（エンティティ関係図）

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    users    │     │ customers   │     │  products   │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ id (PK)     │────┐│ id (PK)     │     │ id (PK)     │
│ username    │    ││customer_code│     │product_code │
│ email       │    ││ name        │     │ name        │
│ password_h. │    ││ email       │     │ description │
│ role        │    ││ phone       │     │ price       │
│ created_at  │    ││ address     │     │ stock_qty   │
│ updated_at  │    ││ created_by  │─────┤ category    │
└─────────────┘    │└─────────────┘     │ created_by  │─────┐
       │           │                    │ created_at  │     │
       │           │                    │ updated_at  │     │
       │           │                    └─────────────┘     │
       │           │                                        │
       │           ▼                                        │
       │    ┌─────────────┐                                 │
       │    │   orders    │                                 │
       │    ├─────────────┤                                 │
       │    │ id (PK)     │                                 │
       │    │order_number │                                 │
       │    │customer_id  │─────────────────────────────────┤
       │    │total_amount │                                 │
       │    │ status      │                                 │
       │    │ order_date  │                                 │
       │    │ created_by  │─────┐                           │
       │    │ created_at  │     │                           │
       │    │ updated_at  │     │                           │
       │    └─────────────┘     │                           │
       │           │             │                           │
       │           ▼             │                           │
       │    ┌─────────────┐     │                           │
       │    │ order_items │     │                           │
       │    ├─────────────┤     │                           │
       │    │ id (PK)     │     │                           │
       │    │ order_id(FK)│─────┘                           │
       │    │ product_id  │─────────────────────────────────┘
       │    │ quantity    │
       │    │ unit_price  │
       │    │ subtotal    │
       │    │ created_at  │
       │    └─────────────┘
       │                    
       ▼                    
┌─────────────────────────────────┐
│      permission_matrix          │
├─────────────────────────────────┤
│ id (PK)                         │
│ user_id (FK)                    │
│ entity_type                     │
│ operation_type                  │
│ screen_name                     │
│ is_allowed                      │
│ created_at                      │
│ updated_at                      │
└─────────────────────────────────┘
```

## 🏷️ TypeScript型定義

### フロントエンド型定義（frontend/src/types/index.ts）

#### 基本エンティティ型

```typescript
// ユーザー型
export interface User {
  id: number
  username: string
  email: string
  role: string
  created_at: string
  updated_at: string
}

// 顧客型
export interface Customer {
  id: number
  customer_code: string
  name: string
  email?: string
  phone?: string
  address?: string
  created_at: string
  updated_at: string
  created_by: number
}

// 商品型
export interface Product {
  id: number
  product_code: string
  name: string
  description?: string
  price: number
  stock_quantity: number
  category?: string
  created_at: string
  updated_at: string
  created_by: number
}

// 注文型
export interface Order {
  id: number
  order_number: string
  customer_id: number
  total_amount: number
  status: 'pending' | 'confirmed' | 'shipped' | 'delivered' | 'cancelled'
  order_date: string
  created_at: string
  updated_at: string
  created_by: number
  customer?: Partial<Customer>
  items?: OrderItem[]
}

// 注文明細型
export interface OrderItem {
  id: number
  order_id: number
  product_id: number
  quantity: number
  unit_price: number
  subtotal: number
  created_at: string
  product?: Partial<Product>
}

// 権限マトリックス型
export interface PermissionMatrix {
  id: number
  user_id: number
  entity_type: 'customers' | 'products' | 'orders'
  operation_type: 'create' | 'read' | 'update' | 'delete'
  screen_name: string
  is_allowed: boolean
  created_at: string
  updated_at: string
}
```

#### API関連型

```typescript
// API レスポンス型
export interface ApiResponse<T = any> {
  success: boolean
  data?: T
  message?: string
  error?: string
}

// ページネーションレスポンス型
export interface PaginatedResponse<T> {
  data: T[]
  total: number
  page: number
  limit: number
  totalPages: number
}

// 認証レスポンス型
export interface AuthResponse {
  user: User
  token: string
}

// フォーム型
export interface LoginForm {
  username: string
  password: string
}

export interface CustomerForm {
  customer_code: string
  name: string
  email?: string
  phone?: string
  address?: string
}

export interface ProductForm {
  product_code: string
  name: string
  description?: string
  price: number
  stock_quantity?: number
  category?: string
}
```

### バックエンド型定義（backend/src/types/index.ts）

#### リクエスト・レスポンス型

```typescript
// 顧客作成リクエスト
export interface CreateCustomerRequest {
  customer_code: string
  name: string
  email?: string
  phone?: string
  address?: string
}

// 商品作成リクエスト
export interface CreateProductRequest {
  product_code: string
  name: string
  description?: string
  price: number
  stock_quantity?: number
  category?: string
}

// 注文作成リクエスト
export interface CreateOrderRequest {
  customer_id: number
  items: {
    product_id: number
    quantity: number
    unit_price: number
  }[]
}

// 認証リクエスト
export interface AuthRequest {
  username: string
  password: string
}
```

## 🎯 データモデルクラス設計

### 1. BaseModel（基底クラス）

```typescript
export abstract class BaseModel {
  // データベース接続取得
  protected static async getDb(): Promise<Database>
  
  // 基本クエリ実行メソッド
  protected static async executeQuery<T>(sql: string, params?: any[]): Promise<T[]>
  protected static async executeQuerySingle<T>(sql: string, params?: any[]): Promise<T | undefined>
  protected static async executeInsert(sql: string, params?: any[]): Promise<number>
  protected static async executeUpdate(sql: string, params?: any[]): Promise<number>
  
  // ユーティリティメソッド
  protected static buildWhereClause(filters: Record<string, any>): {
    whereClause: string
    params: any[]
  }
  protected static buildPaginationClause(page?: number, limit?: number): {
    paginationClause: string
    offset: number
    actualLimit: number
  }
}
```

**特徴**:
- 全データモデルの基底クラス
- 共通のCRUD操作を抽象化
- SQLiteデータベースアクセスの統一化
- 型安全なクエリ実行

### 2. UserModel（ユーザーモデル）

```typescript
export class UserModel extends BaseModel {
  // 主要メソッド
  static async findAll(): Promise<User[]>
  static async findById(id: number): Promise<User | undefined>
  static async findByUsername(username: string): Promise<User | undefined>
  static async findByEmail(email: string): Promise<User | undefined>
  static async create(username: string, email: string, password: string, role?: string): Promise<number>
  static async authenticate(username: string, password: string): Promise<User | null>
  static async updatePassword(id: number, newPassword: string): Promise<boolean>
  static async updateRole(id: number, role: string): Promise<boolean>
  static async delete(id: number): Promise<boolean>
  static async isUsernameExists(username: string, excludeId?: number): Promise<boolean>
  static async isEmailExists(email: string, excludeId?: number): Promise<boolean>
}
```

**特徴**:
- bcryptによるパスワードハッシュ化
- 認証機能（authenticate）
- 管理者ユーザー削除保護
- 重複チェック機能

### 3. CustomerModel（顧客モデル）

```typescript
export class CustomerModel extends BaseModel {
  // 主要メソッド
  static async findAll(filters: {
    name?: string, email?: string, customer_code?: string, page?: number, limit?: number
  }): Promise<{ customers: Customer[]; total: number }>
  static async findById(id: number): Promise<Customer | undefined>
  static async findByCode(customer_code: string): Promise<Customer | undefined>
  static async create(data: CreateCustomerRequest, created_by: number): Promise<number>
  static async update(id: number, data: UpdateCustomerRequest): Promise<boolean>
  static async delete(id: number): Promise<boolean>
  static async isCodeExists(customer_code: string, excludeId?: number): Promise<boolean>
}
```

**特徴**:
- 部分一致検索機能（名前、メール）
- ページネーション対応
- 関連注文チェック（削除時）
- 顧客コード重複チェック

### 4. ProductModel（商品モデル）

```typescript
export class ProductModel extends BaseModel {
  // 主要メソッド
  static async findAll(filters: {
    name?: string, category?: string, product_code?: string, page?: number, limit?: number
  }): Promise<{ products: Product[]; total: number }>
  static async findById(id: number): Promise<Product | undefined>
  static async findByCode(product_code: string): Promise<Product | undefined>
  static async create(data: CreateProductRequest, created_by: number): Promise<number>
  static async update(id: number, data: UpdateProductRequest): Promise<boolean>
  static async delete(id: number): Promise<boolean>
  static async updateStock(id: number, quantity: number): Promise<boolean>
  static async getCategories(): Promise<string[]>
  static async isCodeExists(product_code: string, excludeId?: number): Promise<boolean>
}
```

**特徴**:
- 在庫管理機能（updateStock）
- カテゴリ一覧取得
- 関連注文アイテムチェック（削除時）
- 商品コード重複チェック

### 5. OrderModel（注文モデル）

```typescript
export class OrderModel extends BaseModel {
  // 主要メソッド
  static async findAll(filters: {
    customer_id?: number, status?: string, order_number?: string, page?: number, limit?: number
  }): Promise<{ orders: Order[]; total: number }>
  static async findById(id: number): Promise<Order | undefined>
  static async findByOrderNumber(order_number: string): Promise<Order | undefined>
  static async create(data: CreateOrderRequest, created_by: number): Promise<number>
  static async update(id: number, data: UpdateOrderRequest): Promise<boolean>
  static async delete(id: number): Promise<boolean>
  static async updateStatus(id: number, status: Order['status']): Promise<boolean>
  private static async generateOrderNumber(): Promise<string>
  private static async getOrderItems(orderId: number): Promise<OrderItem[]>
  static async isOrderNumberExists(order_number: string, excludeId?: number): Promise<boolean>
}
```

**特徴**:
- トランザクション管理（作成・更新・削除）
- 注文番号自動生成（日付ベース）
- 注文明細の関連管理
- 顧客・商品情報の結合取得

### 6. PermissionModel（権限モデル）

```typescript
export class PermissionModel extends BaseModel {
  // 主要メソッド
  static async findByUserId(userId: number): Promise<PermissionMatrix[]>
  static async checkPermission(userId: number, entityType: string, operationType: string, screenName: string): Promise<boolean>
  static async setPermission(userId: number, entityType: string, operationType: string, screenName: string, isAllowed: boolean): Promise<boolean>
  static async setUserPermissions(userId: number, permissions: Array<{...}>): Promise<boolean>
  static async getPermissionMatrix(): Promise<{
    screens: Array<{...}>
    users: User[]
    permissions: Record<string, Record<string, boolean>>
  }>
  static async initializeDefaultPermissions(userId: number, role?: string): Promise<void>
  private static getDefaultPermissionsByRole(role: string)
}
```

**特徴**:
- 権限チェック機能
- 権限マトリックス生成
- デフォルト権限設定
- ロール別権限管理

## 📊 データ検証・制約

### 1. データベースレベル制約
- **主キー制約**: 自動インクリメント
- **外部キー制約**: 参照整合性保証
- **UNIQUE制約**: 重複防止（コード、メール等）
- **NOT NULL制約**: 必須フィールド
- **DEFAULT値**: 初期値設定

### 2. アプリケーションレベル検証
- **入力値検証**: Zodスキーマ
- **型検証**: TypeScript型システム
- **業務ルール検証**: モデル内ビジネスロジック
- **権限検証**: 権限モデル

### 3. セキュリティ考慮
- **パスワードハッシュ化**: bcrypt（ソルトラウンド10）
- **SQLインジェクション対策**: パラメータ化クエリ
- **XSS対策**: 入力値サニタイゼーション
- **認証トークン**: JWT（HS256）

---

*最終更新: 2024年1月15日*  
*作成者: システムアナリスト*
